# Plot Twist: Genre War - 기술 설계 문서

## 1. 시스템 아키텍처

### 1.1 전체 구조

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              CLIENT                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Next.js 15 (React)                            │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │   │
│  │  │  Game UI    │  │  WebSocket  │  │  State Management       │  │   │
│  │  │  Components │  │  Client     │  │  (Zustand/TanStack)     │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP / WebSocket
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              SERVER                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Spring Boot 3.x                               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │   │
│  │  │  REST API   │  │  WebSocket  │  │  Game Engine            │  │   │
│  │  │  Controller │  │  (STOMP)    │  │  (State Machine)        │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │   │
│  │  │  AI Service │  │  Game       │  │  Score                  │  │   │
│  │  │  (Spring AI)│  │  Service    │  │  Service                │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
            │ PostgreSQL  │ │    Redis    │ │  OpenAI API │
            │ (Data)      │ │ (Session/   │ │ (LLM)       │
            │             │ │  Cache)     │ │             │
            └─────────────┘ └─────────────┘ └─────────────┘
```

### 1.2 기술 스택

| 레이어 | 기술 | 버전 | 용도 |
|--------|------|------|------|
| **Frontend** | Next.js | 15.x | SSR, 라우팅, UI |
| | React | 19.x | 컴포넌트 |
| | TypeScript | 5.x | 타입 안정성 |
| | Zustand | 5.x | 상태 관리 |
| | TanStack Query | 5.x | 서버 상태 |
| | Tailwind CSS | 4.x | 스타일링 |
| **Backend** | Spring Boot | 3.5.x | 메인 프레임워크 |
| | Spring AI | 1.1.x | LLM 통합 |
| | Spring WebSocket | - | 실시간 통신 |
| | Spring Data JPA | - | ORM |
| **Database** | PostgreSQL | 16.x | 메인 DB |
| | Redis | 7.x | 세션, 캐시, 타이머 |
| **AI** | OpenAI API | gpt-4o-mini | LLM |
| **Infra** | Docker | - | 컨테이너 |

---

## 2. 데이터베이스 설계

### 2.1 ERD

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              ERD                                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   game_session  │       │   participant   │       │     keyword     │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ PK session_id   │──┐    │ PK participant_ │       │ PK keyword_id   │
│    status       │  │    │    id           │       │    word         │
│    max_turns    │  └───▶│ FK session_id   │◀──┐   │    target_genre │
│    turn_time    │       │    type         │   │   │    difficulty   │
│    current_turn │       │    secret_genre │   │   └─────────────────┘
│    initial_     │       │ FK current_     │───┘            │
│    situation    │       │    keyword_id   │                │
│    created_at   │       │    guesses_     │                │
│    updated_at   │       │    remaining    │                │
│    finished_at  │       │    score        │                │
└─────────────────┘       └─────────────────┘                │
         │                        │                          │
         │                        │                          │
         ▼                        ▼                          │
┌─────────────────┐       ┌─────────────────┐               │
│  story_entry    │       │  guess_attempt  │               │
├─────────────────┤       ├─────────────────┤               │
│ PK entry_id     │       │ PK guess_id     │               │
│ FK session_id   │       │ FK participant_ │               │
│    turn         │       │    id           │               │
│    author       │       │    turn         │               │
│    content      │       │    guessed_word │               │
│ FK keyword_used │───────│    is_correct   │───────────────┘
│    created_at   │       │    created_at   │
│    time_spent   │       └─────────────────┘
└─────────────────┘
         │
         │
         ▼
┌─────────────────┐       ┌─────────────────┐
│  score_event    │       │  game_result    │
├─────────────────┤       ├─────────────────┤
│ PK event_id     │       │ PK result_id    │
│ FK participant_ │       │ FK session_id   │
│    id           │       │    player_score │
│    turn         │       │    ai_score     │
│    event_type   │       │    winner       │
│    points       │       │    genre_       │
│    description  │       │    analysis     │
│    created_at   │       │    quality_     │
└─────────────────┘       │    factor       │
                          │    created_at   │
                          └─────────────────┘
```

### 2.2 테이블 정의

#### game_session (게임 세션)
```sql
CREATE TABLE game_session (
    session_id      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    status          VARCHAR(20) NOT NULL DEFAULT 'WAITING',
    max_turns       INTEGER NOT NULL DEFAULT 10,
    turn_time_limit INTEGER NOT NULL DEFAULT 90,
    current_turn    INTEGER NOT NULL DEFAULT 0,
    initial_situation TEXT,
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    finished_at     TIMESTAMP WITH TIME ZONE,
    
    CONSTRAINT chk_status CHECK (status IN ('WAITING', 'IN_PROGRESS', 'FINISHED', 'CANCELLED'))
);

CREATE INDEX idx_game_session_status ON game_session(status);
CREATE INDEX idx_game_session_created_at ON game_session(created_at);
```

#### keyword (제시어)
```sql
CREATE TABLE keyword (
    keyword_id      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    word            VARCHAR(50) NOT NULL,
    target_genre    VARCHAR(20) NOT NULL,
    difficulty      VARCHAR(10) NOT NULL DEFAULT 'NORMAL',
    
    CONSTRAINT chk_target_genre CHECK (target_genre IN ('ROMANCE', 'THRILLER', 'COMEDY', 'SF', 'FANTASY', 'MYSTERY')),
    CONSTRAINT chk_difficulty CHECK (difficulty IN ('EASY', 'NORMAL', 'HARD'))
);

CREATE INDEX idx_keyword_genre ON keyword(target_genre);
CREATE INDEX idx_keyword_difficulty ON keyword(difficulty);

-- 초기 제시어 데이터
INSERT INTO keyword (word, target_genre, difficulty) VALUES
-- 로맨스 제시어 (스릴러 플레이어에게 배정)
('꽃다발', 'ROMANCE', 'EASY'),
('커플링', 'ROMANCE', 'EASY'),
('프로포즈', 'ROMANCE', 'NORMAL'),
('웨딩드레스', 'ROMANCE', 'NORMAL'),
('백허그', 'ROMANCE', 'HARD'),
-- 스릴러 제시어 (로맨스 플레이어에게 배정)
('단검', 'THRILLER', 'EASY'),
('비명', 'THRILLER', 'EASY'),
('시체', 'THRILLER', 'NORMAL'),
('살인마', 'THRILLER', 'NORMAL'),
('좀비', 'THRILLER', 'HARD');
```

#### participant (참가자)
```sql
CREATE TABLE participant (
    participant_id      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id          UUID NOT NULL REFERENCES game_session(session_id) ON DELETE CASCADE,
    type                VARCHAR(10) NOT NULL,
    secret_genre        VARCHAR(20) NOT NULL,
    current_keyword_id  UUID REFERENCES keyword(keyword_id),
    keyword_status      VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    guesses_remaining   INTEGER NOT NULL DEFAULT 3,
    score               INTEGER NOT NULL DEFAULT 0,
    keywords_used       INTEGER NOT NULL DEFAULT 0,
    keywords_digested   INTEGER NOT NULL DEFAULT 0,
    correct_guesses     INTEGER NOT NULL DEFAULT 0,
    wrong_guesses       INTEGER NOT NULL DEFAULT 0,
    
    CONSTRAINT chk_type CHECK (type IN ('PLAYER', 'AI')),
    CONSTRAINT chk_secret_genre CHECK (secret_genre IN ('ROMANCE', 'THRILLER', 'COMEDY', 'SF', 'FANTASY', 'MYSTERY')),
    CONSTRAINT chk_keyword_status CHECK (keyword_status IN ('PENDING', 'USED', 'DIGESTED', 'CAUGHT'))
);

CREATE INDEX idx_participant_session ON participant(session_id);
CREATE UNIQUE INDEX idx_participant_session_type ON participant(session_id, type);
```

#### story_entry (스토리 항목)
```sql
CREATE TABLE story_entry (
    entry_id        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id      UUID NOT NULL REFERENCES game_session(session_id) ON DELETE CASCADE,
    turn            INTEGER NOT NULL,
    author          VARCHAR(10) NOT NULL,
    content         TEXT NOT NULL,
    keyword_used_id UUID REFERENCES keyword(keyword_id),
    time_spent      INTEGER,
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_author CHECK (author IN ('PLAYER', 'AI'))
);

CREATE INDEX idx_story_entry_session ON story_entry(session_id);
CREATE INDEX idx_story_entry_session_turn ON story_entry(session_id, turn);
```

#### guess_attempt (추측 시도)
```sql
CREATE TABLE guess_attempt (
    guess_id        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    participant_id  UUID NOT NULL REFERENCES participant(participant_id) ON DELETE CASCADE,
    turn            INTEGER NOT NULL,
    guessed_word    VARCHAR(50) NOT NULL,
    is_correct      BOOLEAN NOT NULL,
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_guess_attempt_participant ON guess_attempt(participant_id);
```

#### score_event (점수 이벤트)
```sql
CREATE TABLE score_event (
    event_id        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    participant_id  UUID NOT NULL REFERENCES participant(participant_id) ON DELETE CASCADE,
    turn            INTEGER NOT NULL,
    event_type      VARCHAR(30) NOT NULL,
    points          INTEGER NOT NULL,
    description     TEXT,
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_event_type CHECK (event_type IN ('GUESS_CORRECT', 'GUESS_WRONG', 'DIGEST_SUCCESS', 'GENRE_WIN', 'GENRE_BONUS'))
);

CREATE INDEX idx_score_event_participant ON score_event(participant_id);
```

#### game_result (게임 결과)
```sql
CREATE TABLE game_result (
    result_id       UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id      UUID NOT NULL UNIQUE REFERENCES game_session(session_id) ON DELETE CASCADE,
    player_score    INTEGER NOT NULL,
    ai_score        INTEGER NOT NULL,
    winner          VARCHAR(10) NOT NULL,
    genre_analysis  JSONB NOT NULL,
    quality_factor  DECIMAL(3,2) NOT NULL,
    unnatural_elements JSONB,
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_winner CHECK (winner IN ('PLAYER', 'AI', 'DRAW'))
);

-- genre_analysis 예시:
-- {
--   "ROMANCE": 65,
--   "THRILLER": 35,
--   "COMEDY": 0,
--   ...
-- }

-- unnatural_elements 예시:
-- [
--   {"turn": 3, "element": "코끼리", "reason": "맥락 없이 등장"},
--   ...
-- ]
```

### 2.3 Redis 데이터 구조

```
# 게임 세션 상태 (실시간)
game:session:{sessionId}
{
  "status": "IN_PROGRESS",
  "currentTurn": 5,
  "turnStartTime": 1706345678000,
  "playerConnected": true,
  "aiThinking": false
}
TTL: 2시간

# 턴 타이머
game:timer:{sessionId}
TTL: 90초 (턴 시간)

# 플레이어 추측 기회 (빠른 조회용)
game:guesses:{sessionId}:player
"3"

game:guesses:{sessionId}:ai
"2"
```

---

## 3. API 설계

### 3.1 REST API

#### 3.1.1 게임 세션 API

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/games` | 새 게임 생성 |
| GET | `/api/games/{sessionId}` | 게임 정보 조회 |
| POST | `/api/games/{sessionId}/start` | 게임 시작 |
| DELETE | `/api/games/{sessionId}` | 게임 취소 |

**POST /api/games - 새 게임 생성**
```json
// Request
{
  "difficulty": "NORMAL",
  "maxTurns": 10,
  "turnTimeLimit": 90
}

// Response 201 Created
{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "WAITING",
  "player": {
    "participantId": "...",
    "secretGenre": "ROMANCE",
    "keyword": {
      "word": "좀비",
      "status": "PENDING"
    },
    "guessesRemaining": 3,
    "score": 0
  },
  "settings": {
    "maxTurns": 10,
    "turnTimeLimit": 90
  },
  "createdAt": "2026-01-27T10:00:00Z"
}
```

**GET /api/games/{sessionId} - 게임 정보 조회**
```json
// Response 200 OK
{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "IN_PROGRESS",
  "currentTurn": 5,
  "player": {
    "secretGenre": "ROMANCE",
    "keyword": {
      "word": "좀비",
      "status": "PENDING"
    },
    "guessesRemaining": 2,
    "score": 5
  },
  "story": [
    {
      "turn": 1,
      "author": "SYSTEM",
      "content": "10년 만에 고향에 돌아온 민수는..."
    },
    {
      "turn": 2,
      "author": "AI",
      "content": "카페 문을 열자..."
    },
    {
      "turn": 3,
      "author": "PLAYER",
      "content": "민수는 심장이 뛰었다..."
    }
  ],
  "settings": {
    "maxTurns": 10,
    "turnTimeLimit": 90
  }
}
```

#### 3.1.2 게임 플레이 API

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/games/{sessionId}/story` | 플레이어 스토리 제출 |
| POST | `/api/games/{sessionId}/guess` | 제시어 추측 |
| GET | `/api/games/{sessionId}/result` | 게임 결과 조회 |

**POST /api/games/{sessionId}/story - 스토리 제출**
```json
// Request
{
  "content": "민수는 수진에게 다가갔다. \"좀비 영화 보러 갈래?\"",
  "useKeyword": true
}

// Response 200 OK
{
  "success": true,
  "turn": 4,
  "keywordUsed": true,
  "keywordStatus": "USED",
  "nextTurn": {
    "turn": 5,
    "author": "AI",
    "timeLimit": 90
  }
}
```

**POST /api/games/{sessionId}/guess - 제시어 추측**
```json
// Request
{
  "guessWord": "웨딩드레스"
}

// Response 200 OK
{
  "correct": true,
  "points": 5,
  "guessesRemaining": 2,
  "totalScore": 10,
  "message": "정답! AI의 제시어는 '웨딩드레스'였습니다."
}

// 또는 오답인 경우
{
  "correct": false,
  "points": -1,
  "guessesRemaining": 1,
  "totalScore": 4,
  "message": "오답입니다. AI의 제시어가 아닙니다."
}
```

**GET /api/games/{sessionId}/result - 게임 결과**
```json
// Response 200 OK
{
  "sessionId": "...",
  "winner": "PLAYER",
  "genreAnalysis": {
    "ROMANCE": 62,
    "THRILLER": 38
  },
  "qualityFactor": {
    "player": 1.0,
    "ai": 0.8
  },
  "finalScores": {
    "ROMANCE": 62.0,
    "THRILLER": 30.4
  },
  "scores": {
    "player": {
      "total": 21,
      "breakdown": {
        "genreWin": 10,
        "genreBonus": 5,
        "guessCorrect": 5,
        "guessWrong": -1,
        "digestSuccess": 2
      }
    },
    "ai": {
      "total": 8,
      "breakdown": {
        "genreWin": 0,
        "guessCorrect": 10,
        "guessWrong": -2,
        "digestSuccess": 0
      }
    }
  },
  "revealed": {
    "playerGenre": "ROMANCE",
    "aiGenre": "THRILLER",
    "playerKeywords": [
      {"word": "좀비", "status": "DIGESTED", "usedAtTurn": 4}
    ],
    "aiKeywords": [
      {"word": "웨딩드레스", "status": "CAUGHT", "usedAtTurn": 3, "caughtAtTurn": 5},
      {"word": "프로포즈", "status": "CAUGHT", "usedAtTurn": 7, "caughtAtTurn": 8}
    ]
  },
  "unnaturalElements": [
    {"turn": 6, "element": "까마귀", "reason": "맥락 없이 등장"}
  ],
  "fullStory": "..."
}
```

### 3.2 WebSocket API (STOMP)

#### 3.2.1 연결 설정
```
CONNECT
destination: /ws/game
```

#### 3.2.2 구독 채널

| 채널 | 설명 | 메시지 방향 |
|------|------|------------|
| `/topic/game/{sessionId}` | 게임 이벤트 수신 | Server → Client |
| `/user/queue/errors` | 에러 메시지 | Server → Client |

#### 3.2.3 발행 채널

| 채널 | 설명 | 메시지 방향 |
|------|------|------------|
| `/app/game/{sessionId}/ready` | 게임 준비 완료 | Client → Server |
| `/app/game/{sessionId}/story` | 스토리 제출 | Client → Server |
| `/app/game/{sessionId}/guess` | 제시어 추측 | Client → Server |

#### 3.2.4 서버 이벤트 메시지

**게임 시작**
```json
{
  "type": "GAME_STARTED",
  "payload": {
    "sessionId": "...",
    "initialSituation": "10년 만에 고향에 돌아온 민수는...",
    "firstTurn": {
      "turn": 1,
      "author": "AI",
      "timeLimit": null
    }
  }
}
```

**AI 턴 완료**
```json
{
  "type": "AI_TURN_COMPLETED",
  "payload": {
    "turn": 2,
    "content": "카페 문을 열자 오래된 종소리가 울렸다.",
    "nextTurn": {
      "turn": 3,
      "author": "PLAYER",
      "timeLimit": 90,
      "startTime": 1706345678000
    }
  }
}
```

**플레이어 턴 완료**
```json
{
  "type": "PLAYER_TURN_COMPLETED",
  "payload": {
    "turn": 3,
    "content": "민수는 심장이 뛰기 시작했다.",
    "keywordUsed": false,
    "nextTurn": {
      "turn": 4,
      "author": "AI"
    }
  }
}
```

**추측 결과**
```json
{
  "type": "GUESS_RESULT",
  "payload": {
    "guesser": "PLAYER",
    "guessWord": "웨딩드레스",
    "correct": true,
    "points": 5,
    "guessesRemaining": 2,
    "totalScore": 10
  }
}
```

**타이머 업데이트**
```json
{
  "type": "TIMER_UPDATE",
  "payload": {
    "remainingSeconds": 45,
    "turn": 3
  }
}
```

**타이머 만료**
```json
{
  "type": "TIMER_EXPIRED",
  "payload": {
    "turn": 3,
    "author": "PLAYER",
    "penalty": "턴 스킵"
  }
}
```

**게임 종료**
```json
{
  "type": "GAME_FINISHED",
  "payload": {
    "reason": "ALL_TURNS_COMPLETED",
    "resultAvailable": true
  }
}
```

---

## 4. 시퀀스 다이어그램

### 4.1 게임 시작 플로우

```
┌──────┐          ┌──────┐          ┌───────┐          ┌─────┐          ┌───────┐
│Client│          │Server│          │GameSvc│          │Redis│          │   DB  │
└──┬───┘          └──┬───┘          └───┬───┘          └──┬──┘          └───┬───┘
   │                 │                  │                 │                 │
   │ POST /api/games │                  │                 │                 │
   │────────────────>│                  │                 │                 │
   │                 │ createGame()     │                 │                 │
   │                 │─────────────────>│                 │                 │
   │                 │                  │                 │                 │
   │                 │                  │ 장르 배정       │                 │
   │                 │                  │ (ROMANCE vs THRILLER)             │
   │                 │                  │                 │                 │
   │                 │                  │ 제시어 배정     │                 │
   │                 │                  │ (상대 장르에서 랜덤)              │
   │                 │                  │                 │                 │
   │                 │                  │ INSERT game_session               │
   │                 │                  │────────────────────────────────>│
   │                 │                  │                 │                 │
   │                 │                  │ INSERT participant (x2)          │
   │                 │                  │────────────────────────────────>│
   │                 │                  │                 │                 │
   │                 │                  │ SET game:session:{id}            │
   │                 │                  │────────────────>│                 │
   │                 │                  │                 │                 │
   │                 │<─────────────────│                 │                 │
   │                 │  GameSession     │                 │                 │
   │<────────────────│                  │                 │                 │
   │  201 Created    │                  │                 │                 │
   │                 │                  │                 │                 │
   │ WS CONNECT      │                  │                 │                 │
   │────────────────>│                  │                 │                 │
   │                 │                  │                 │                 │
   │ SUBSCRIBE       │                  │                 │                 │
   │ /topic/game/{id}│                  │                 │                 │
   │────────────────>│                  │                 │                 │
   │                 │                  │                 │                 │
   │ SEND /app/game/{id}/ready         │                 │                 │
   │────────────────>│                  │                 │                 │
   │                 │ startGame()      │                 │                 │
   │                 │─────────────────>│                 │                 │
   │                 │                  │                 │                 │
   │                 │                  │ 초기 상황 생성  │                 │
   │                 │                  │ (AI 호출)       │                 │
   │                 │                  │                 │                 │
   │                 │                  │ UPDATE status='IN_PROGRESS'      │
   │                 │                  │────────────────────────────────>│
   │                 │                  │                 │                 │
   │                 │<─────────────────│                 │                 │
   │<────────────────│                  │                 │                 │
   │ GAME_STARTED    │                  │                 │                 │
   │                 │                  │                 │                 │
```

### 4.2 턴 진행 플로우

```
┌──────┐          ┌──────┐          ┌───────┐          ┌──────┐          ┌─────┐
│Client│          │Server│          │GameSvc│          │AI Svc│          │ DB  │
└──┬───┘          └──┬───┘          └───┬───┘          └──┬───┘          └──┬──┘
   │                 │                  │                 │                 │
   │                 │ AI 턴 시작       │                 │                 │
   │                 │─────────────────>│                 │                 │
   │                 │                  │ writeStory()    │                 │
   │                 │                  │────────────────>│                 │
   │                 │                  │                 │ OpenAI API      │
   │                 │                  │                 │ (Story Writer)  │
   │                 │                  │<────────────────│                 │
   │                 │                  │                 │                 │
   │                 │                  │ INSERT story_entry               │
   │                 │                  │───────────────────────────────>│
   │                 │<─────────────────│                 │                 │
   │<────────────────│                  │                 │                 │
   │ AI_TURN_COMPLETED                  │                 │                 │
   │                 │                  │                 │                 │
   │                 │                  │                 │                 │
   │                 │ 타이머 시작 (90초)                 │                 │
   │                 │─────────────────>│                 │                 │
   │<────────────────│                  │                 │                 │
   │ TIMER_UPDATE    │                  │                 │                 │
   │ (매 10초)       │                  │                 │                 │
   │                 │                  │                 │                 │
   │ SEND /story     │                  │                 │                 │
   │ {content, useKw}│                  │                 │                 │
   │────────────────>│                  │                 │                 │
   │                 │ submitStory()    │                 │                 │
   │                 │─────────────────>│                 │                 │
   │                 │                  │                 │                 │
   │                 │                  │ 제시어 포함 여부 체크             │
   │                 │                  │ (text.contains(keyword))          │
   │                 │                  │                 │                 │
   │                 │                  │ INSERT story_entry               │
   │                 │                  │───────────────────────────────>│
   │                 │                  │                 │                 │
   │                 │                  │ UPDATE participant               │
   │                 │                  │ (keyword_status)                 │
   │                 │                  │───────────────────────────────>│
   │                 │<─────────────────│                 │                 │
   │<────────────────│                  │                 │                 │
   │ PLAYER_TURN_    │                  │                 │                 │
   │ COMPLETED       │                  │                 │                 │
   │                 │                  │                 │                 │
```

### 4.3 추측 플로우

```
┌──────┐          ┌──────┐          ┌───────┐          ┌─────┐
│Client│          │Server│          │GameSvc│          │ DB  │
└──┬───┘          └──┬───┘          └───┬───┘          └──┬──┘
   │                 │                  │                 │
   │ SEND /guess     │                  │                 │
   │ {guessWord}     │                  │                 │
   │────────────────>│                  │                 │
   │                 │ processGuess()   │                 │
   │                 │─────────────────>│                 │
   │                 │                  │                 │
   │                 │                  │ 추측 기회 확인  │
   │                 │                  │ (guessesRemaining > 0?)          │
   │                 │                  │                 │
   │                 │                  │ 상대 제시어 상태 확인             │
   │                 │                  │ (status == 'USED'?)              │
   │                 │                  │                 │
   │                 │                  │ 단어 비교       │
   │                 │                  │ (guessWord == keyword?)          │
   │                 │                  │                 │
   │                 │                  │ [정답인 경우]   │
   │                 │                  │ - 추측자 +5점   │
   │                 │                  │ - 상대 새 제시어│
   │                 │                  │                 │
   │                 │                  │ [오답인 경우]   │
   │                 │                  │ - 추측자 -1점   │
   │                 │                  │ - 기회 -1       │
   │                 │                  │                 │
   │                 │                  │ INSERT guess_attempt             │
   │                 │                  │───────────────────────────────>│
   │                 │                  │                 │
   │                 │                  │ INSERT score_event              │
   │                 │                  │───────────────────────────────>│
   │                 │                  │                 │
   │                 │                  │ UPDATE participant              │
   │                 │                  │───────────────────────────────>│
   │                 │<─────────────────│                 │
   │<────────────────│                  │                 │
   │ GUESS_RESULT    │                  │                 │
   │                 │                  │                 │
```

### 4.4 게임 종료 플로우

```
┌──────┐          ┌──────┐          ┌───────┐          ┌──────┐          ┌─────┐
│Client│          │Server│          │GameSvc│          │AI Svc│          │ DB  │
└──┬───┘          └──┬───┘          └───┬───┘          └──┬───┘          └──┬──┘
   │                 │                  │                 │                 │
   │                 │ 마지막 턴 완료   │                 │                 │
   │                 │─────────────────>│                 │                 │
   │                 │                  │                 │                 │
   │                 │                  │ finishGame()    │                 │
   │                 │                  │                 │                 │
   │                 │                  │ 전체 스토리 조합│                 │
   │                 │                  │                 │                 │
   │                 │                  │ analyzeGenre()  │                 │
   │                 │                  │────────────────>│                 │
   │                 │                  │                 │ OpenAI API      │
   │                 │                  │                 │ (Genre Judge)   │
   │                 │                  │<────────────────│                 │
   │                 │                  │                 │                 │
   │                 │                  │ 장르 비율 계산  │                 │
   │                 │                  │ 품질 계수 적용  │                 │
   │                 │                  │ 최종 점수 계산  │                 │
   │                 │                  │                 │                 │
   │                 │                  │ 소화 성공 보너스 계산             │
   │                 │                  │ (DIGESTED 키워드 +2점씩)          │
   │                 │                  │                 │                 │
   │                 │                  │ 승자 결정       │                 │
   │                 │                  │                 │                 │
   │                 │                  │ INSERT game_result               │
   │                 │                  │───────────────────────────────>│
   │                 │                  │                 │                 │
   │                 │                  │ UPDATE game_session              │
   │                 │                  │ (status='FINISHED')              │
   │                 │                  │───────────────────────────────>│
   │                 │<─────────────────│                 │                 │
   │<────────────────│                  │                 │                 │
   │ GAME_FINISHED   │                  │                 │                 │
   │                 │                  │                 │                 │
   │ GET /result     │                  │                 │                 │
   │────────────────>│                  │                 │                 │
   │                 │ getResult()      │                 │                 │
   │                 │─────────────────>│                 │                 │
   │                 │                  │ SELECT game_result               │
   │                 │                  │───────────────────────────────>│
   │                 │<─────────────────│<──────────────────────────────│
   │<────────────────│                  │                 │                 │
   │ 200 OK (결과)   │                  │                 │                 │
   │                 │                  │                 │                 │
```

---

## 5. 컴포넌트 구조

### 5.1 Backend (Spring Boot)

```
src/main/java/com/example/plottwist/
├── PlotTwistApplication.java
├── config/
│   ├── WebSocketConfig.java
│   ├── SecurityConfig.java
│   ├── RedisConfig.java
│   └── AiConfig.java
├── controller/
│   ├── GameRestController.java
│   └── GameWebSocketController.java
├── service/
│   ├── GameService.java
│   ├── StoryService.java
│   ├── GuessService.java
│   ├── ScoreService.java
│   ├── TimerService.java
│   └── ai/
│       ├── GenreJudgeService.java
│       ├── StoryWriterService.java
│       └── KeywordGuesserService.java
├── domain/
│   ├── entity/
│   │   ├── GameSession.java
│   │   ├── Participant.java
│   │   ├── Keyword.java
│   │   ├── StoryEntry.java
│   │   ├── GuessAttempt.java
│   │   ├── ScoreEvent.java
│   │   └── GameResult.java
│   ├── enums/
│   │   ├── GameStatus.java
│   │   ├── Genre.java
│   │   ├── ParticipantType.java
│   │   ├── KeywordStatus.java
│   │   └── ScoreEventType.java
│   └── repository/
│       ├── GameSessionRepository.java
│       ├── ParticipantRepository.java
│       ├── KeywordRepository.java
│       ├── StoryEntryRepository.java
│       ├── GuessAttemptRepository.java
│       ├── ScoreEventRepository.java
│       └── GameResultRepository.java
├── dto/
│   ├── request/
│   │   ├── CreateGameRequest.java
│   │   ├── SubmitStoryRequest.java
│   │   └── GuessRequest.java
│   ├── response/
│   │   ├── GameResponse.java
│   │   ├── StoryResponse.java
│   │   ├── GuessResponse.java
│   │   └── GameResultResponse.java
│   └── websocket/
│       ├── GameEvent.java
│       ├── GameEventType.java
│       └── WebSocketMessage.java
├── prompt/
│   └── PromptTemplates.java
└── exception/
    ├── GameException.java
    ├── GameNotFoundException.java
    ├── InvalidTurnException.java
    └── GlobalExceptionHandler.java
```

### 5.2 Frontend (Next.js)

```
src/
├── app/
│   ├── layout.tsx
│   ├── page.tsx                    # 홈
│   ├── game/
│   │   ├── page.tsx                # 게임 로비
│   │   └── [sessionId]/
│   │       ├── page.tsx            # 게임 플레이
│   │       └── result/
│   │           └── page.tsx        # 결과 화면
│   └── api/                        # API Routes (if needed)
├── components/
│   ├── game/
│   │   ├── GameBoard.tsx           # 메인 게임 보드
│   │   ├── StoryDisplay.tsx        # 스토리 표시
│   │   ├── StoryInput.tsx          # 스토리 입력
│   │   ├── KeywordDisplay.tsx      # 제시어 표시
│   │   ├── GuessPanel.tsx          # 추측 패널
│   │   ├── ScoreBoard.tsx          # 점수판
│   │   ├── Timer.tsx               # 타이머
│   │   ├── Memo.tsx                # 메모장
│   │   └── TurnIndicator.tsx       # 턴 표시
│   ├── result/
│   │   ├── ResultSummary.tsx       # 결과 요약
│   │   ├── GenreChart.tsx          # 장르 차트
│   │   ├── ScoreBreakdown.tsx      # 점수 분석
│   │   ├── KeywordReveal.tsx       # 제시어 공개
│   │   └── StoryHighlight.tsx      # 스토리 하이라이트
│   └── ui/
│       ├── Button.tsx
│       ├── Modal.tsx
│       ├── Card.tsx
│       └── Progress.tsx
├── hooks/
│   ├── useGame.ts                  # 게임 상태 관리
│   ├── useWebSocket.ts             # WebSocket 연결
│   ├── useTimer.ts                 # 타이머
│   └── useGuess.ts                 # 추측 로직
├── stores/
│   └── gameStore.ts                # Zustand 스토어
├── services/
│   ├── api.ts                      # REST API 클라이언트
│   └── websocket.ts                # WebSocket 클라이언트
├── types/
│   ├── game.ts                     # 게임 타입
│   ├── story.ts                    # 스토리 타입
│   └── websocket.ts                # WebSocket 타입
└── utils/
    ├── format.ts                   # 포맷팅 유틸
    └── constants.ts                # 상수
```

---

## 6. 핵심 로직

### 6.1 제시어 포함 여부 체크

```java
@Service
public class KeywordService {
    
    /**
     * 텍스트에 제시어가 포함되어 있는지 확인
     * - 조사 결합 허용: "좀비가", "좀비를" 등
     * - 합성어 허용: "좀비영화", "좀비처럼" 등
     */
    public boolean containsKeyword(String text, String keyword) {
        if (text == null || keyword == null) {
            return false;
        }
        return text.contains(keyword);
    }
}
```

### 6.2 추측 처리

```java
@Service
@RequiredArgsConstructor
public class GuessService {
    
    private final ParticipantRepository participantRepository;
    private final KeywordRepository keywordRepository;
    private final GuessAttemptRepository guessAttemptRepository;
    private final ScoreService scoreService;
    
    @Transactional
    public GuessResult processGuess(UUID sessionId, String guesser, String guessWord) {
        // 1. 참가자 조회
        Participant guesserParticipant = participantRepository
            .findBySessionIdAndType(sessionId, ParticipantType.valueOf(guesser))
            .orElseThrow();
        
        Participant opponent = participantRepository
            .findBySessionIdAndType(sessionId, getOpponentType(guesser))
            .orElseThrow();
        
        // 2. 추측 기회 확인
        if (guesserParticipant.getGuessesRemaining() <= 0) {
            return GuessResult.noChances();
        }
        
        // 3. 상대 제시어 상태 확인
        Keyword opponentKeyword = opponent.getCurrentKeyword();
        
        if (opponentKeyword == null || 
            opponent.getKeywordStatus() != KeywordStatus.USED) {
            // 상대가 아직 제시어를 사용하지 않음 → 무조건 오답
            return processWrongGuess(guesserParticipant, guessWord, 
                "상대가 아직 제시어를 사용하지 않았습니다.");
        }
        
        // 4. 정답 확인
        if (opponentKeyword.getWord().equals(guessWord)) {
            return processCorrectGuess(guesserParticipant, opponent, guessWord);
        } else {
            return processWrongGuess(guesserParticipant, guessWord, 
                "오답입니다.");
        }
    }
    
    private GuessResult processCorrectGuess(
            Participant guesser, Participant opponent, String guessWord) {
        // 점수 +5
        scoreService.addScore(guesser, ScoreEventType.GUESS_CORRECT, 5);
        
        // 상대 제시어 상태 변경
        opponent.setKeywordStatus(KeywordStatus.CAUGHT);
        
        // 상대에게 새 제시어 배정
        Keyword newKeyword = assignNewKeyword(opponent);
        opponent.setCurrentKeyword(newKeyword);
        opponent.setKeywordStatus(KeywordStatus.PENDING);
        
        // 추측 기록 저장
        saveGuessAttempt(guesser, guessWord, true);
        
        return GuessResult.correct(guessWord, 5, guesser.getGuessesRemaining());
    }
    
    private GuessResult processWrongGuess(
            Participant guesser, String guessWord, String message) {
        // 점수 -1
        scoreService.addScore(guesser, ScoreEventType.GUESS_WRONG, -1);
        
        // 기회 차감
        guesser.decrementGuesses();
        
        // 추측 기록 저장
        saveGuessAttempt(guesser, guessWord, false);
        
        return GuessResult.wrong(guessWord, -1, guesser.getGuessesRemaining(), message);
    }
}
```

### 6.3 게임 종료 및 결과 계산

```java
@Service
@RequiredArgsConstructor
public class GameFinishService {
    
    private final GenreJudgeService genreJudgeService;
    private final ScoreService scoreService;
    private final GameResultRepository gameResultRepository;
    
    @Transactional
    public GameResult finishGame(GameSession session) {
        // 1. 전체 스토리 조합
        String fullStory = buildFullStory(session);
        
        // 2. 장르 판정 (AI 호출)
        GenreAnalysis analysis = genreJudgeService.analyzeStory(fullStory);
        
        // 3. 소화 성공 보너스 계산
        calculateDigestBonus(session);
        
        // 4. 장르 승리 점수 계산
        calculateGenreScore(session, analysis);
        
        // 5. 최종 점수 합산
        int playerScore = scoreService.getTotalScore(session.getPlayer());
        int aiScore = scoreService.getTotalScore(session.getAi());
        
        // 6. 승자 결정
        String winner = determineWinner(playerScore, aiScore);
        
        // 7. 결과 저장
        GameResult result = GameResult.builder()
            .session(session)
            .playerScore(playerScore)
            .aiScore(aiScore)
            .winner(winner)
            .genreAnalysis(analysis.getGenreAnalysis())
            .qualityFactor(analysis.getQualityFactor())
            .unnaturalElements(analysis.getUnnaturalElements())
            .build();
        
        return gameResultRepository.save(result);
    }
    
    private void calculateGenreScore(GameSession session, GenreAnalysis analysis) {
        Participant player = session.getPlayer();
        Participant ai = session.getAi();
        
        // 플레이어 장르 최종 점수
        double playerGenreScore = analysis.getFinalScore(player.getSecretGenre().name());
        // AI 장르 최종 점수
        double aiGenreScore = analysis.getFinalScore(ai.getSecretGenre().name());
        
        if (playerGenreScore > aiGenreScore) {
            // 플레이어 장르 승리
            scoreService.addScore(player, ScoreEventType.GENRE_WIN, 10);
            
            // 압도적 승리 보너스 (70% 이상)
            if (playerGenreScore >= 70) {
                scoreService.addScore(player, ScoreEventType.GENRE_BONUS, 5);
            }
        } else if (aiGenreScore > playerGenreScore) {
            // AI 장르 승리
            scoreService.addScore(ai, ScoreEventType.GENRE_WIN, 10);
            
            if (aiGenreScore >= 70) {
                scoreService.addScore(ai, ScoreEventType.GENRE_BONUS, 5);
            }
        }
        // 동점이면 장르 점수 없음
    }
    
    private void calculateDigestBonus(GameSession session) {
        // 플레이어 소화 성공 보너스
        if (session.getPlayer().getKeywordStatus() == KeywordStatus.USED) {
            // 사용했지만 안 들킴 → DIGESTED로 변경
            session.getPlayer().setKeywordStatus(KeywordStatus.DIGESTED);
            scoreService.addScore(session.getPlayer(), ScoreEventType.DIGEST_SUCCESS, 2);
        }
        
        // AI도 동일하게 처리
        if (session.getAi().getKeywordStatus() == KeywordStatus.USED) {
            session.getAi().setKeywordStatus(KeywordStatus.DIGESTED);
            scoreService.addScore(session.getAi(), ScoreEventType.DIGEST_SUCCESS, 2);
        }
    }
}
```

---

## 7. 보안 고려사항

### 7.1 API 보안

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())  // REST API이므로 CSRF 비활성화
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/games/**").permitAll()  // MVP: 인증 없이
                .requestMatchers("/ws/**").permitAll()
                .anyRequest().authenticated()
            );
        
        return http.build();
    }
}
```

### 7.2 입력 검증

```java
public record SubmitStoryRequest(
    @NotBlank(message = "스토리 내용은 필수입니다")
    @Size(max = 500, message = "스토리는 500자를 초과할 수 없습니다")
    String content,
    
    boolean useKeyword
) {}

public record GuessRequest(
    @NotBlank(message = "추측 단어는 필수입니다")
    @Size(min = 2, max = 50, message = "추측 단어는 2-50자 사이여야 합니다")
    String guessWord
) {}
```

### 7.3 Rate Limiting

```java
@Aspect
@Component
public class RateLimitAspect {
    
    private final RedisTemplate<String, String> redisTemplate;
    
    @Around("@annotation(RateLimit)")
    public Object rateLimit(ProceedingJoinPoint joinPoint, RateLimit rateLimit) {
        String key = "rate:" + getClientId() + ":" + joinPoint.getSignature().getName();
        
        Long count = redisTemplate.opsForValue().increment(key);
        if (count == 1) {
            redisTemplate.expire(key, rateLimit.period(), TimeUnit.SECONDS);
        }
        
        if (count > rateLimit.limit()) {
            throw new RateLimitExceededException("요청 한도를 초과했습니다");
        }
        
        return joinPoint.proceed();
    }
}
```

---

## 8. 성능 고려사항

### 8.1 Redis 캐싱

```java
@Service
public class GameCacheService {
    
    private final RedisTemplate<String, Object> redisTemplate;
    
    // 게임 세션 캐시 (자주 조회)
    public void cacheGameSession(GameSession session) {
        String key = "game:session:" + session.getId();
        redisTemplate.opsForValue().set(key, session, Duration.ofHours(2));
    }
    
    // 제시어 풀 캐시 (변경 거의 없음)
    @Cacheable(value = "keywords", key = "#genre + ':' + #difficulty")
    public List<Keyword> getKeywordsByGenreAndDifficulty(Genre genre, Difficulty difficulty) {
        return keywordRepository.findByTargetGenreAndDifficulty(genre, difficulty);
    }
}
```

### 8.2 DB 인덱스

```sql
-- 주요 쿼리 최적화를 위한 인덱스
CREATE INDEX idx_game_session_status_created ON game_session(status, created_at DESC);
CREATE INDEX idx_story_entry_session_turn ON story_entry(session_id, turn);
CREATE INDEX idx_participant_session_type ON participant(session_id, type);
```

### 8.3 WebSocket 최적화

```java
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {
    
    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        config.enableSimpleBroker("/topic", "/queue")
            .setHeartbeatValue(new long[]{10000, 10000})  // 10초 heartbeat
            .setTaskScheduler(heartBeatScheduler());
        config.setApplicationDestinationPrefixes("/app");
    }
    
    @Override
    public void configureWebSocketTransport(WebSocketTransportRegistration registry) {
        registry.setMessageSizeLimit(64 * 1024);  // 64KB
        registry.setSendBufferSizeLimit(512 * 1024);  // 512KB
        registry.setSendTimeLimit(20000);  // 20초
    }
}
```

---

## 9. 배포 구성

### 9.1 Docker Compose (개발/테스트)

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/plottwist
      - SPRING_REDIS_HOST=redis
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - db
      - redis
  
  db:
    image: postgres:16
    environment:
      - POSTGRES_DB=plottwist
      - POSTGRES_USER=plottwist
      - POSTGRES_PASSWORD=plottwist
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

volumes:
  postgres_data:
```

### 9.2 환경 변수

```properties
# application-prod.yml
spring:
  datasource:
    url: ${DATABASE_URL}
    username: ${DATABASE_USERNAME}
    password: ${DATABASE_PASSWORD}
  redis:
    host: ${REDIS_HOST}
    port: ${REDIS_PORT}
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
```

---

## 10. MVP 개발 일정 (예상)

| 단계 | 작업 |  |
|------|------|----------|
| **1. 프로젝트 설정** | Spring Boot, Next.js 초기 설정 | 
| **2. DB 구축** | 스키마 생성, 초기 데이터 | 
| **3. 핵심 도메인** | Entity, Repository, Service 기본 | 
| **4. 게임 로직** | 턴 관리, 점수, 제시어 | 
| **5. AI 통합** | Spring AI 연동 (이미 검증됨) | 
| **6. REST API** | 컨트롤러, DTO | 
| **7. WebSocket** | 실시간 통신 | 
| **8. Frontend 기본** | 게임 UI 컴포넌트 |
| **9. Frontend 통합** | API 연동, 상태 관리 |
| **10. 테스트 & 버그 수정** | 통합 테스트 |

---

## 11. 요약

| 항목 | 내용 |
|------|------|
| **아키텍처** | 모놀리식 (MVP), 추후 마이크로서비스 전환 가능 |
| **Backend** | Spring Boot 3.x + Spring AI + WebSocket |
| **Frontend** | Next.js 15 + Zustand + TanStack Query |
| **Database** | PostgreSQL (영구 데이터) + Redis (세션/캐시) |
| **실시간 통신** | STOMP over WebSocket |
| **AI** | OpenAI gpt-4o-mini (검증 완료된 프롬프트) |